import{j as t}from"./jsx-runtime.D_zvdyIk.js";import{r as l}from"./index.BVOCwoKb.js";import{u as ce}from"./GastosContext.WmsTZqJf.js";import{u as de}from"./useCurrency.Ird2pE4I.js";import"./supabase.4P1wv7wr.js";import{m as E,A as Q}from"./proxy.dwpEO49j.js";const me=c=>c.reduce((f,h)=>{const{mes:b,monto:y}=h;return f[b]||(f[b]=0),f[b]+=y,f},{}),ue={Enero:"#FF6384",Febrero:"#FF9F40",Marzo:"#FFCE56",Abril:"#4BC0C0",Mayo:"#36A2EB",Junio:"#9966FF",Julio:"#FF6384",Agosto:"#FF9F40",Septiembre:"#FFCE56",Octubre:"#4BC0C0",Noviembre:"#36A2EB",Diciembre:"#9966FF"},xe=(c,f,h)=>{if(!c||!c.startsWith("#"))return"#C9CBCF";try{const b=parseInt(c.slice(1,3),16),y=parseInt(c.slice(3,5),16),S=parseInt(c.slice(5,7),16),d=.2+f/h*.6,L=Math.round(b*d),N=Math.round(y*d),R=Math.round(S*d);return`#${L.toString(16).padStart(2,"0")}${N.toString(16).padStart(2,"0")}${R.toString(16).padStart(2,"0")}`}catch(b){return console.error("Error al generar tono de color:",b),"#C9CBCF"}},pe=c=>{const f=c.charAt(0).toUpperCase()+c.slice(1).toLowerCase();return ue[f]||"#C9CBCF"},Me=()=>{const{gastos:c,personas:f,emailsMap:h}=ce(),{formatCurrency:b}=de(),y=l.useRef(null),S=l.useRef(null),[d,L]=l.useState("mes"),[N,R]=l.useState("todos"),[Z,B]=l.useState(0),[M,G]=l.useState(null),[p,$]=l.useState(null),[_,q]=l.useState(!1),z=l.useRef(0),[ee,V]=l.useState(!1),[C,W]=l.useState(null),[he,fe]=l.useState(!1),[ge,je]=l.useState({title:"",value:0}),[be,ye]=l.useState({x:0,y:0}),J=l.useCallback(e=>e.reduce((n,s)=>{const o=h[s.personaid]||s.personaid;return s.escompartido?(s.porcentajepersona1&&(n[o]=(n[o]||0)+s.monto*s.porcentajepersona1/100),s.porcentajepersona2&&s.otraPersonaEmail&&(n[s.otraPersonaEmail]=(n[s.otraPersonaEmail]||0)+s.monto*s.porcentajepersona2/100)):n[o]=(n[o]||0)+s.monto,n},{}),[h]),D=l.useCallback(()=>{const e=[...c];return p&&p.monto&&p.monto>0&&p.mes&&p.personaid&&e.push(p),N==="todos"?e:e.filter(n=>h[n.personaid]===N||n.personaid===N||n.escompartido&&n.otraPersonaEmail===N)},[N,c,p,h]),T=l.useCallback(()=>d==="mes"?me(D()):J(D()),[d,D,J]),U=l.useCallback(e=>{const n=Object.values(e).reduce((s,o)=>s+o,0);return n===0?{}:Object.entries(e).reduce((s,[o,a])=>(s[o]=a/n*100,s),{})},[]),P=l.useCallback(()=>{const e=T();return U(e)},[U,T]),K=l.useCallback(e=>{const n=f.find(s=>s.id===e);return n?n.nombre:e},[f]),te=l.useCallback(e=>{const n=["#4F46E5","#EC4899","#10B981","#F59E0B","#3B82F6","#8B5CF6","#EF4444","#14B8A6","#F97316","#6366F1"];let s=0;for(let a=0;a<e.length;a++)s=e.charCodeAt(a)+((s<<5)-s);const o=Math.abs(s)%n.length;return n[o]},[]),I=e=>{if(d==="mes"){const n=pe(e),s=c.filter(a=>a.mes===e),o=s.findIndex(a=>a===c[c.length-1]);return xe(n,o,s.length)}else return te(e)},w=l.useCallback((e=1)=>{if(!y.current)return;const n=y.current,s=n.getContext("2d");if(!s)return;const o=window.devicePixelRatio||1,a=n.getBoundingClientRect();n.width=a.width*o,n.height=a.height*o,s.scale(o,o),n.style.width=`${a.width}px`,n.style.height=`${a.height}px`,s.clearRect(0,0,a.width,a.height);const m=a.width/2,u=a.height/2,g=Math.min(m,u)-20,j=P();if(Object.keys(j).length===0){s.fillStyle="#F3F4F6",s.beginPath(),s.arc(m,u,g,0,Math.PI*2),s.fill(),s.fillStyle="#9CA3AF",s.font="bold 16px Inter, system-ui, sans-serif",s.textAlign="center",s.textBaseline="middle",s.fillText("No hay datos",m,u);return}let i=0;Object.entries(j).forEach(([r,x])=>{const k=x*e,v=i+k/100*(Math.PI*2),A=i+(v-i)/2,F=M===r?10:0,X=F*Math.cos(A),Y=F*Math.sin(A);s.fillStyle=I(r),s.beginPath(),s.moveTo(m+X,u+Y),s.arc(m+X,u+Y,g,i,v),s.lineTo(m+X,u+Y),s.closePath(),s.fill(),s.strokeStyle="#FFFFFF",s.lineWidth=2,s.stroke(),i=v})},[P,M,I]),se=({clave:e,porcentaje:n,monto:s,x:o,y:a})=>{const m=d==="mes"?e:`${K(e)} (${e})`;return t.jsx(E.div,{className:"absolute z-50 bg-white rounded-xl shadow-lg border border-gray-100 p-4 min-w-[200px]",style:{left:`${o}px`,top:`${a}px`,transform:"translate(-50%, -100%)"},initial:{opacity:0,y:10},animate:{opacity:1,y:0},exit:{opacity:0,y:10},transition:{duration:.2},children:t.jsxs("div",{className:"flex flex-col space-y-2",children:[t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx("div",{className:"w-3 h-3 rounded-full",style:{backgroundColor:I(e)}}),t.jsx("span",{className:"font-medium text-gray-900 text-sm",children:m})]}),t.jsx("div",{className:"text-sm text-gray-600",children:b(s)}),t.jsxs("div",{className:"text-sm font-semibold text-indigo-600",children:[n.toFixed(1),"%"]})]})})},ne=l.useCallback(e=>{if(!y.current)return;const s=y.current.getBoundingClientRect(),o=e.clientX-s.left,a=e.clientY-s.top,m=s.width/2,u=s.height/2,g=Math.min(m,u)-20,j=o-m,i=a-u;if(Math.sqrt(j*j+i*i)>g){G(null);return}let x=Math.atan2(i,j);x<0&&(x+=2*Math.PI);const k=P();let v=0;for(const[A,O]of Object.entries(k)){const F=v+O/100*(Math.PI*2);if(x>=v&&x<F){G(A);return}v=F}G(null)},[P]);l.useEffect(()=>{const e=c.length,n=e>z.current;if(z.current=e,!n){w(1);return}q(!0),B(0);let s;const o=800,a=m=>{s||(s=m);const u=m-s,g=Math.min(u/o,1);B(g),w(g),g<1?S.current=requestAnimationFrame(a):q(!1)};return S.current=requestAnimationFrame(a),()=>{S.current&&cancelAnimationFrame(S.current)}},[c,d,N,w]),l.useEffect(()=>{p&&w(1)},[p,w]),l.useEffect(()=>{w(1);const e=()=>{B(0),$(null),w(1)},n=o=>{B(0),$(null),w(1)},s=o=>{$(o.detail),w(1)};return window.addEventListener("nuevoGasto",e),window.addEventListener("gastoEliminado",n),document.addEventListener("gastoPreview",s),()=>{window.removeEventListener("nuevoGasto",e),window.removeEventListener("gastoEliminado",n),document.removeEventListener("gastoPreview",s)}},[c,d,Z,w]);const ae=Object.entries(T()).sort(([,e],[,n])=>n-e),oe=Object.values(T()).reduce((e,n)=>e+n,0),re=()=>p&&p.monto&&p.monto>0?t.jsx("span",{className:"absolute top-0 right-0 bg-indigo-100 text-indigo-800 text-xs font-medium px-2.5 py-0.5 rounded-md",children:"Vista previa activa"}):null,ie=e=>({backgroundColor:I(e)}),H=l.useCallback(e=>{let n=[],s="",o="";d==="mes"?(n=c.filter(i=>i.mes===e),s=`Gastos de ${e}`,o=`${n.length} gastos registrados`):(n=c.filter(r=>{const x=h[r.personaid]||r.personaid,k=r.otraPersonaEmail;return x===e||r.escompartido&&k===e}),s=`Gastos de ${f.find(r=>h[r.id]===e)?.nombre||e}`,o=e);const a=n.reduce((i,r)=>{if(d==="email"){const x=h[r.personaid]||r.personaid;if(r.escompartido){if(x===e)return i+r.monto*(r.porcentajepersona1||0)/100;if(r.otraPersonaEmail===e)return i+r.monto*(r.porcentajepersona2||0)/100}}return i+r.monto},0),m=n.filter(i=>i.escompartido),u=n.filter(i=>!i.escompartido),g=m.reduce((i,r)=>{if(d==="email"){if((h[r.personaid]||r.personaid)===e)return i+r.monto*(r.porcentajepersona1||0)/100;if(r.otraPersonaEmail===e)return i+r.monto*(r.porcentajepersona2||0)/100}return i+r.monto},0),j=u.reduce((i,r)=>i+r.monto,0);W({gastos:n,titulo:s,subtitulo:o,total:a,estadisticas:{totalGastos:n.length,gastosCompartidos:m.length,gastosNoCompartidos:u.length,totalCompartido:g,totalNoCompartido:j,porcentajeCompartido:a>0?g/a*100:0,porcentajeNoCompartido:a>0?j/a*100:0}}),V(!0)},[d,c,f,h]),le=l.useCallback(e=>{if(!y.current)return;const s=y.current.getBoundingClientRect(),o=e.clientX-s.left,a=e.clientY-s.top,m=s.width/2,u=s.height/2,g=Math.min(m,u)-20,j=o-m,i=a-u;if(Math.sqrt(j*j+i*i)>g)return;let x=Math.atan2(i,j);x<0&&(x+=2*Math.PI);const k=P();let v=0;for(const[A,O]of Object.entries(k)){const F=v+O/100*(Math.PI*2);if(x>=v&&x<F){H(A);return}v=F}},[P,H]);return t.jsxs(E.div,{className:"w-full h-full",initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.5},children:[t.jsxs("div",{className:"mb-4 sm:mb-6 flex flex-col sm:flex-row gap-4",children:[t.jsxs(E.div,{className:"flex items-center space-x-2 bg-white p-2 rounded-lg shadow-sm border border-gray-100",whileHover:{scale:1.02},whileTap:{scale:.98},children:[t.jsx("span",{className:"text-gray-600 text-sm sm:text-base",children:"Ver por:"}),t.jsxs("select",{value:d,onChange:e=>L(e.target.value),className:"p-1.5 sm:p-2 border rounded-md bg-gray-50 focus:ring-2 focus:ring-indigo-200 focus:border-indigo-500 outline-none text-sm sm:text-base",children:[t.jsx("option",{value:"mes",children:"Mes"}),t.jsx("option",{value:"email",children:"Email"})]})]}),t.jsxs(E.div,{className:"flex items-center space-x-2 bg-white p-2 rounded-lg shadow-sm border border-gray-100",whileHover:{scale:1.02},whileTap:{scale:.98},children:[t.jsx("span",{className:"text-gray-600 text-sm sm:text-base",children:"Filtrar:"}),d==="email"&&t.jsxs("select",{value:N,onChange:e=>R(e.target.value),className:"p-1.5 sm:p-2 border rounded-md bg-gray-50 focus:ring-2 focus:ring-indigo-200 focus:border-indigo-500 outline-none text-sm sm:text-base",children:[t.jsx("option",{value:"todos",children:"Todos"}),Object.values(h).concat(c.filter(e=>e.escompartido&&e.otraPersonaEmail).map(e=>e.otraPersonaEmail)).filter((e,n,s)=>e&&s.indexOf(e)===n).sort().map(e=>t.jsx("option",{value:e,children:e},e))]})]})]}),t.jsxs(E.div,{className:"relative bg-white rounded-xl shadow-md p-2 sm:p-4 md:p-6 border border-gray-100",animate:_?{scale:[1,1.02,1]}:{scale:1},transition:{duration:.3},children:[t.jsx(re,{}),t.jsx("div",{className:"relative w-full aspect-square max-w-[300px] mx-auto",children:t.jsx("div",{className:"relative w-full h-full flex items-center justify-center",children:t.jsxs("div",{className:"relative w-[300px] h-[300px]",children:[t.jsx("canvas",{ref:y,className:"absolute inset-0 w-full h-full cursor-pointer",onMouseMove:ne,onMouseLeave:()=>G(null),onClick:le}),t.jsx(Q,{children:M&&t.jsx(se,{clave:M,porcentaje:P()[M],monto:T()[M],x:150,y:150})})]})})}),t.jsx("div",{className:"mt-4 sm:mt-6 grid grid-cols-1 sm:grid-cols-2 gap-2 sm:gap-3",children:ae.map(([e,n])=>{const s=p&&(d==="mes"&&p.mes===e||d==="email"&&p.personaid===e);return t.jsxs(E.div,{className:`flex items-center p-2 sm:p-3 rounded-lg transition-colors ${M===e?"bg-gray-100":s?"bg-indigo-50 border border-indigo-100":"hover:bg-gray-50"}`,onMouseEnter:()=>G(e),onMouseLeave:()=>G(null),whileHover:{scale:1.02},whileTap:{scale:.98},onClick:()=>{d==="mes"&&H(e)},children:[t.jsx("span",{className:"w-4 h-4 sm:w-5 sm:h-5 rounded-md inline-block mr-2 sm:mr-3 shadow-sm",style:ie(e)}),t.jsxs("div",{className:"flex-1 min-w-0",children:[t.jsx("span",{className:"font-medium text-gray-800 text-sm sm:text-base truncate",children:d==="mes"?e:K(e)}),t.jsxs("div",{className:"flex justify-between mt-0.5 sm:mt-1",children:[t.jsx("span",{className:"text-xs sm:text-sm text-gray-600 truncate mr-2",children:b(n)}),t.jsxs("span",{className:"text-xs sm:text-sm font-semibold text-indigo-600 whitespace-nowrap",children:[(n/oe*100).toFixed(1),"%"]})]})]})]},e)})})]}),t.jsx(Q,{children:C&&ee&&t.jsx(E.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"fixed inset-0 z-50 flex items-center justify-center p-4",children:t.jsxs(E.div,{initial:{scale:.9,y:20},animate:{scale:1,y:0},exit:{scale:.9,y:20},transition:{type:"spring",damping:25,stiffness:300},className:"relative bg-white rounded-xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-hidden",children:[t.jsx("div",{className:"absolute top-0 left-0 right-0 h-2 bg-gradient-to-r from-indigo-500 to-purple-500"}),t.jsxs("div",{className:"p-6",children:[t.jsxs("div",{className:"flex items-center justify-between mb-6",children:[t.jsxs("div",{children:[t.jsx("h2",{className:"text-2xl font-bold text-gray-900",children:C.titulo}),t.jsx("p",{className:"text-gray-500",children:C.subtitulo})]}),t.jsx("button",{onClick:()=>{V(!1),W(null)},className:"p-2 rounded-full hover:bg-gray-100 transition-colors","aria-label":"Cerrar modal",children:t.jsx("svg",{className:"w-6 h-6 text-gray-500",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]}),t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6 mb-6",children:[t.jsxs("div",{className:"bg-gray-50 rounded-lg p-4",children:[t.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-2",children:"Resumen"}),t.jsxs("div",{className:"space-y-2",children:[t.jsxs("div",{className:"flex justify-between",children:[t.jsx("span",{className:"text-gray-600",children:"Total Gastos"}),t.jsx("span",{className:"font-medium",children:C.estadisticas.totalGastos})]}),t.jsxs("div",{className:"flex justify-between",children:[t.jsx("span",{className:"text-gray-600",children:"Total Monto"}),t.jsx("span",{className:"font-medium",children:b(C.total)})]})]})]}),t.jsxs("div",{className:"bg-gray-50 rounded-lg p-4",children:[t.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-2",children:"Distribución"}),t.jsxs("div",{className:"space-y-2",children:[t.jsxs("div",{className:"flex justify-between",children:[t.jsx("span",{className:"text-gray-600",children:"Gastos Compartidos"}),t.jsx("span",{className:"font-medium",children:C.estadisticas.gastosCompartidos})]}),t.jsxs("div",{className:"flex justify-between",children:[t.jsx("span",{className:"text-gray-600",children:"Gastos Individuales"}),t.jsx("span",{className:"font-medium",children:C.estadisticas.gastosNoCompartidos})]})]})]})]}),t.jsx("div",{className:"overflow-auto max-h-[50vh]",children:t.jsxs("table",{className:"min-w-full divide-y divide-gray-200",children:[t.jsx("thead",{className:"bg-gray-50",children:t.jsxs("tr",{children:[t.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Descripción"}),t.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Monto"}),t.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Tipo"}),t.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Fecha"})]})}),t.jsx("tbody",{className:"bg-white divide-y divide-gray-200",children:C.gastos.map(e=>t.jsxs("tr",{className:"hover:bg-gray-50",children:[t.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-900",children:e.descripcion}),t.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-900",children:b(e.monto)}),t.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-900",children:e.escompartido?t.jsx("span",{className:"inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-indigo-100 text-indigo-800",children:"Compartido"}):t.jsx("span",{className:"inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800",children:"Individual"})}),t.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-900",children:e.mes})]},e.id))})]})})]})]})})})]})};export{Me as P,me as c,xe as g,pe as o};
