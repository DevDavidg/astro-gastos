import{j as t}from"./jsx-runtime.D_zvdyIk.js";import{r as l}from"./index.BVOCwoKb.js";import{u as me,o as ue}from"./GastosContext.BTDxljjR.js";import{u as xe}from"./useCurrency.D8rWf9GG.js";import{m as M,A as Z}from"./proxy.dwpEO49j.js";const pe=c=>c.reduce((f,N)=>{const{mes:p,monto:C}=N;return f[p]||(f[p]=0),f[p]+=C,f},{}),he={Enero:"#FF6384",Febrero:"#FF9F40",Marzo:"#FFCE56",Abril:"#4BC0C0",Mayo:"#36A2EB",Junio:"#9966FF",Julio:"#FF6384",Agosto:"#FF9F40",Septiembre:"#FFCE56",Octubre:"#4BC0C0",Noviembre:"#36A2EB",Diciembre:"#9966FF"},fe=(c,f,N)=>{if(!c||!c.startsWith("#"))return"#C9CBCF";try{const p=parseInt(c.slice(1,3),16),C=parseInt(c.slice(3,5),16),m=parseInt(c.slice(5,7),16),B=.2+f/N*.6,w=Math.round(p*B),R=Math.round(C*B),$=Math.round(m*B);return`#${w.toString(16).padStart(2,"0")}${R.toString(16).padStart(2,"0")}${$.toString(16).padStart(2,"0")}`}catch(p){return console.error("Error al generar tono de color:",p),"#C9CBCF"}},ge=c=>{const f=c.charAt(0).toUpperCase()+c.slice(1).toLowerCase();return he[f]||"#C9CBCF"},Ce=()=>{const{gastos:c,personas:f}=me(),{formatCurrency:N}=xe(),p=l.useRef(null),C=l.useRef(null),[m,B]=l.useState("mes"),[w,R]=l.useState("todos"),[$,O]=l.useState(0),[P,G]=l.useState(null),[h,D]=l.useState(null),[je,_]=l.useState(null),[ee,q]=l.useState(!1),z=l.useRef(0),[te,V]=l.useState(!1),[F,W]=l.useState(null),[y,se]=l.useState({});l.useEffect(()=>{(async()=>{const n={};for(const s of c)if(!n[s.personaid]){const a=await ue(s.personaid);a&&(n[s.personaid]=a)}se(n)})()},[c]);const J=l.useCallback(e=>e.reduce((n,s)=>{const a=y[s.personaid]||s.personaid;return s.escompartido?(s.porcentajepersona1&&(n[a]=(n[a]||0)+s.monto*s.porcentajepersona1/100),s.porcentajepersona2&&s.otraPersonaEmail&&(n[s.otraPersonaEmail]=(n[s.otraPersonaEmail]||0)+s.monto*s.porcentajepersona2/100)):n[a]=(n[a]||0)+s.monto,n},{}),[y]),H=l.useCallback(()=>{const e=[...c];return h&&h.monto&&h.monto>0&&h.mes&&h.personaid&&e.push(h),w==="todos"?e:e.filter(n=>y[n.personaid]===w||n.personaid===w||n.escompartido&&n.otraPersonaEmail===w)},[w,c,h,y]),I=l.useCallback(()=>m==="mes"?pe(H()):J(H()),[m,H,J]),U=l.useCallback(e=>{const n=Object.values(e).reduce((s,a)=>s+a,0);return n===0?{}:Object.entries(e).reduce((s,[a,o])=>(s[a]=o/n*100,s),{})},[]),k=l.useCallback(()=>{const e=I();return U(e)},[U,I]),K=l.useCallback(e=>{const n=f.find(s=>s.id===e);return n?n.nombre:e},[f]),ne=l.useCallback(e=>{const n=["#4F46E5","#EC4899","#10B981","#F59E0B","#3B82F6","#8B5CF6","#EF4444","#14B8A6","#F97316","#6366F1"];let s=0;for(let o=0;o<e.length;o++)s=e.charCodeAt(o)+((s<<5)-s);const a=Math.abs(s)%n.length;return n[a]},[]),T=e=>{if(m==="mes"){const n=ge(e),s=c.filter(o=>o.mes===e),a=s.findIndex(o=>o===c[c.length-1]);return fe(n,a,s.length)}else return ne(e)},v=l.useCallback((e=1)=>{if(!p.current)return;const n=p.current,s=n.getContext("2d");if(!s)return;const a=window.devicePixelRatio||1,o=n.getBoundingClientRect();n.width=o.width*a,n.height=o.height*a,s.scale(a,a),n.style.width=`${o.width}px`,n.style.height=`${o.height}px`,s.clearRect(0,0,o.width,o.height);const d=o.width/2,u=o.height/2,g=Math.min(d,u)-20,j=k();if(Object.keys(j).length===0){s.fillStyle="#F3F4F6",s.beginPath(),s.arc(d,u,g,0,Math.PI*2),s.fill(),s.fillStyle="#9CA3AF",s.font="bold 16px Inter, system-ui, sans-serif",s.textAlign="center",s.textBaseline="middle",s.fillText("No hay datos",d,u);return}let i=0;Object.entries(j).forEach(([r,x])=>{const S=x*e,b=i+S/100*(Math.PI*2),A=i+(b-i)/2,E=P===r?10:0,X=E*Math.cos(A),Y=E*Math.sin(A);s.fillStyle=T(r),s.beginPath(),s.moveTo(d+X,u+Y),s.arc(d+X,u+Y,g,i,b),s.lineTo(d+X,u+Y),s.closePath(),s.fill(),s.strokeStyle="#FFFFFF",s.lineWidth=2,s.stroke(),i=b})},[k,P,T]),ae=({clave:e,porcentaje:n,monto:s,x:a,y:o})=>{const d=m==="mes"?e:`${K(e)} (${e})`;return t.jsx(M.div,{className:"absolute z-50 bg-white rounded-xl shadow-lg border border-gray-100 p-4 min-w-[200px]",style:{left:`${a}px`,top:`${o}px`,transform:"translate(-50%, -100%)"},initial:{opacity:0,y:10},animate:{opacity:1,y:0},exit:{opacity:0,y:10},transition:{duration:.2},children:t.jsxs("div",{className:"flex flex-col space-y-2",children:[t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx("div",{className:"w-3 h-3 rounded-full",style:{backgroundColor:T(e)}}),t.jsx("span",{className:"font-medium text-gray-900 text-sm",children:d})]}),t.jsx("div",{className:"text-sm text-gray-600",children:N(s)}),t.jsxs("div",{className:"text-sm font-semibold text-indigo-600",children:[n.toFixed(1),"%"]})]})})},oe=l.useCallback(e=>{if(!p.current)return;const s=p.current.getBoundingClientRect(),a=e.clientX-s.left,o=e.clientY-s.top,d=s.width/2,u=s.height/2,g=Math.min(d,u)-20,j=a-d,i=o-u;if(Math.sqrt(j*j+i*i)>g){G(null);return}let x=Math.atan2(i,j);x<0&&(x+=2*Math.PI);const S=k();let b=0;for(const[A,L]of Object.entries(S)){const E=b+L/100*(Math.PI*2);if(x>=b&&x<E){G(A);return}b=E}G(null)},[k]);l.useEffect(()=>{const e=c.length,n=e>z.current;if(z.current=e,!n){v(1);return}q(!0),O(0);let s;const a=800,o=d=>{s||(s=d);const u=d-s,g=Math.min(u/a,1);O(g),v(g),g<1?C.current=requestAnimationFrame(o):q(!1)};return C.current=requestAnimationFrame(o),()=>{C.current&&cancelAnimationFrame(C.current)}},[c,m,w,v]),l.useEffect(()=>{h&&v(1)},[h,v]),l.useEffect(()=>{v(1);const e=()=>{O(0),D(null),v(1)},n=a=>{O(0),D(null),v(1)},s=a=>{D(a.detail),v(1)};return window.addEventListener("nuevoGasto",e),window.addEventListener("gastoEliminado",n),document.addEventListener("gastoPreview",s),()=>{window.removeEventListener("nuevoGasto",e),window.removeEventListener("gastoEliminado",n),document.removeEventListener("gastoPreview",s)}},[c,m,$,v]);const re=Object.entries(I()).sort(([,e],[,n])=>n-e),ie=Object.values(I()).reduce((e,n)=>e+n,0),le=()=>h&&h.monto&&h.monto>0?t.jsx("span",{className:"absolute top-0 right-0 bg-indigo-100 text-indigo-800 text-xs font-medium px-2.5 py-0.5 rounded-md",children:"Vista previa activa"}):null,ce=e=>({backgroundColor:T(e)}),Q=l.useCallback(e=>{let n=[],s="",a="";m==="mes"?(n=c.filter(i=>i.mes===e),s=`Gastos de ${e}`,a=`${n.length} gastos registrados`):(n=c.filter(r=>{const x=y[r.personaid]||r.personaid,S=r.otraPersonaEmail;return x===e||r.escompartido&&S===e}),s=`Gastos de ${f.find(r=>y[r.id]===e)?.nombre||e}`,a=e);const o=n.reduce((i,r)=>{if(m==="email"){const x=y[r.personaid]||r.personaid;if(r.escompartido){if(x===e)return i+r.monto*(r.porcentajepersona1||0)/100;if(r.otraPersonaEmail===e)return i+r.monto*(r.porcentajepersona2||0)/100}}return i+r.monto},0),d=n.filter(i=>i.escompartido),u=n.filter(i=>!i.escompartido),g=d.reduce((i,r)=>{if(m==="email"){if((y[r.personaid]||r.personaid)===e)return i+r.monto*(r.porcentajepersona1||0)/100;if(r.otraPersonaEmail===e)return i+r.monto*(r.porcentajepersona2||0)/100}return i+r.monto},0),j=u.reduce((i,r)=>i+r.monto,0);W({gastos:n,titulo:s,subtitulo:a,total:o,estadisticas:{totalGastos:n.length,gastosCompartidos:d.length,gastosNoCompartidos:u.length,totalCompartido:g,totalNoCompartido:j,porcentajeCompartido:o>0?g/o*100:0,porcentajeNoCompartido:o>0?j/o*100:0}}),V(!0)},[m,c,f,y]),de=l.useCallback(e=>{if(!p.current)return;const s=p.current.getBoundingClientRect(),a=e.clientX-s.left,o=e.clientY-s.top,d=s.width/2,u=s.height/2,g=Math.min(d,u)-20,j=a-d,i=o-u;if(Math.sqrt(j*j+i*i)>g)return;let x=Math.atan2(i,j);x<0&&(x+=2*Math.PI);const S=k();let b=0;for(const[A,L]of Object.entries(S)){const E=b+L/100*(Math.PI*2);if(x>=b&&x<E){Q(A);return}b=E}},[k,Q]);return t.jsxs(M.div,{className:"w-full h-full",initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.5},children:[t.jsxs("div",{className:"mb-4 sm:mb-6 flex flex-col sm:flex-row gap-4",children:[t.jsxs(M.div,{className:"flex items-center space-x-2 bg-white p-2 rounded-lg shadow-sm border border-gray-100",whileHover:{scale:1.02},whileTap:{scale:.98},children:[t.jsx("span",{className:"text-gray-600 text-sm sm:text-base",children:"Ver por:"}),t.jsxs("select",{value:m,onChange:e=>B(e.target.value),className:"p-1.5 sm:p-2 border rounded-md bg-gray-50 focus:ring-2 focus:ring-indigo-200 focus:border-indigo-500 outline-none text-sm sm:text-base",children:[t.jsx("option",{value:"mes",children:"Mes"}),t.jsx("option",{value:"email",children:"Email"})]})]}),t.jsxs(M.div,{className:"flex items-center space-x-2 bg-white p-2 rounded-lg shadow-sm border border-gray-100",whileHover:{scale:1.02},whileTap:{scale:.98},children:[t.jsx("span",{className:"text-gray-600 text-sm sm:text-base",children:"Filtrar:"}),m==="email"&&t.jsxs("select",{value:w,onChange:e=>R(e.target.value),className:"p-1.5 sm:p-2 border rounded-md bg-gray-50 focus:ring-2 focus:ring-indigo-200 focus:border-indigo-500 outline-none text-sm sm:text-base",children:[t.jsx("option",{value:"todos",children:"Todos"}),Object.values(y).concat(c.filter(e=>e.escompartido&&e.otraPersonaEmail).map(e=>e.otraPersonaEmail)).filter((e,n,s)=>e&&s.indexOf(e)===n).sort().map(e=>t.jsx("option",{value:e,children:e},e))]})]})]}),t.jsxs(M.div,{className:"relative bg-white rounded-xl shadow-md p-2 sm:p-4 md:p-6 border border-gray-100",animate:ee?{scale:[1,1.02,1]}:{scale:1},transition:{duration:.3},children:[t.jsx(le,{}),t.jsx("div",{className:"relative w-full aspect-square max-w-[300px] mx-auto",children:t.jsx("div",{className:"relative w-full h-full flex items-center justify-center",children:t.jsxs("div",{className:"relative w-[300px] h-[300px]",children:[t.jsx("canvas",{ref:p,className:"absolute inset-0 w-full h-full cursor-pointer",onMouseMove:oe,onMouseLeave:()=>G(null),onClick:de}),t.jsx(Z,{children:P&&t.jsx(ae,{clave:P,porcentaje:k()[P],monto:I()[P],x:150,y:150})})]})})}),t.jsx("div",{className:"mt-4 sm:mt-6 grid grid-cols-1 sm:grid-cols-2 gap-2 sm:gap-3",children:re.map(([e,n])=>{const s=h&&(m==="mes"&&h.mes===e||m==="email"&&h.personaid===e);return t.jsxs(M.div,{className:`flex items-center p-2 sm:p-3 rounded-lg transition-colors ${P===e?"bg-gray-100":s?"bg-indigo-50 border border-indigo-100":"hover:bg-gray-50"}`,onMouseEnter:()=>G(e),onMouseLeave:()=>G(null),whileHover:{scale:1.02},whileTap:{scale:.98},onClick:()=>{m==="mes"&&_(e)},children:[t.jsx("span",{className:"w-4 h-4 sm:w-5 sm:h-5 rounded-md inline-block mr-2 sm:mr-3 shadow-sm",style:ce(e)}),t.jsxs("div",{className:"flex-1 min-w-0",children:[t.jsx("span",{className:"font-medium text-gray-800 text-sm sm:text-base truncate",children:m==="mes"?e:K(e)}),t.jsxs("div",{className:"flex justify-between mt-0.5 sm:mt-1",children:[t.jsx("span",{className:"text-xs sm:text-sm text-gray-600 truncate mr-2",children:N(n)}),t.jsxs("span",{className:"text-xs sm:text-sm font-semibold text-indigo-600 whitespace-nowrap",children:[(n/ie*100).toFixed(1),"%"]})]})]})]},e)})})]}),t.jsx(Z,{children:F&&te&&t.jsx(M.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"fixed inset-0 z-50 flex items-center justify-center p-4",children:t.jsxs(M.div,{initial:{scale:.9,y:20},animate:{scale:1,y:0},exit:{scale:.9,y:20},transition:{type:"spring",damping:25,stiffness:300},className:"relative bg-white rounded-xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-hidden",children:[t.jsx("div",{className:"absolute top-0 left-0 right-0 h-2 bg-gradient-to-r from-indigo-500 to-purple-500"}),t.jsxs("div",{className:"p-6",children:[t.jsxs("div",{className:"flex items-center justify-between mb-6",children:[t.jsxs("div",{children:[t.jsx("h2",{className:"text-2xl font-bold text-gray-900",children:F.titulo}),t.jsx("p",{className:"text-gray-500",children:F.subtitulo})]}),t.jsx("button",{onClick:()=>{V(!1),W(null)},className:"p-2 rounded-full hover:bg-gray-100 transition-colors","aria-label":"Cerrar modal",children:t.jsx("svg",{className:"w-6 h-6 text-gray-500",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]}),t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6 mb-6",children:[t.jsxs("div",{className:"bg-gray-50 rounded-lg p-4",children:[t.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-2",children:"Resumen"}),t.jsxs("div",{className:"space-y-2",children:[t.jsxs("div",{className:"flex justify-between",children:[t.jsx("span",{className:"text-gray-600",children:"Total Gastos"}),t.jsx("span",{className:"font-medium",children:F.estadisticas.totalGastos})]}),t.jsxs("div",{className:"flex justify-between",children:[t.jsx("span",{className:"text-gray-600",children:"Total Monto"}),t.jsx("span",{className:"font-medium",children:N(F.total)})]})]})]}),t.jsxs("div",{className:"bg-gray-50 rounded-lg p-4",children:[t.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-2",children:"Distribución"}),t.jsxs("div",{className:"space-y-2",children:[t.jsxs("div",{className:"flex justify-between",children:[t.jsx("span",{className:"text-gray-600",children:"Gastos Compartidos"}),t.jsx("span",{className:"font-medium",children:F.estadisticas.gastosCompartidos})]}),t.jsxs("div",{className:"flex justify-between",children:[t.jsx("span",{className:"text-gray-600",children:"Gastos Individuales"}),t.jsx("span",{className:"font-medium",children:F.estadisticas.gastosNoCompartidos})]})]})]})]}),t.jsx("div",{className:"overflow-auto max-h-[50vh]",children:t.jsxs("table",{className:"min-w-full divide-y divide-gray-200",children:[t.jsx("thead",{className:"bg-gray-50",children:t.jsxs("tr",{children:[t.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Descripción"}),t.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Monto"}),t.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Tipo"}),t.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Fecha"})]})}),t.jsx("tbody",{className:"bg-white divide-y divide-gray-200",children:F.gastos.map(e=>t.jsxs("tr",{className:"hover:bg-gray-50",children:[t.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-900",children:e.descripcion}),t.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-900",children:N(e.monto)}),t.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-900",children:e.escompartido?t.jsx("span",{className:"inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-indigo-100 text-indigo-800",children:"Compartido"}):t.jsx("span",{className:"inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800",children:"Individual"})}),t.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-900",children:e.mes})]},e.id))})]})})]})]})})})]})};export{Ce as P,pe as c,fe as g,ge as o};
