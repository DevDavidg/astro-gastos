import{j as s}from"./jsx-runtime.D_zvdyIk.js";import{r as o}from"./index.BVOCwoKb.js";import{u as ie}from"./GastosContext.BTDxljjR.js";import{u as Q}from"./useCurrency.D8rWf9GG.js";const ce=a=>a.reduce((m,F)=>{const{mes:d,monto:j}=F;return m[d]||(m[d]=0),m[d]+=j,m},{}),le={Enero:"#FF6384",Febrero:"#FF9F40",Marzo:"#FFCE56",Abril:"#4BC0C0",Mayo:"#36A2EB",Junio:"#9966FF",Julio:"#FF6384",Agosto:"#FF9F40",Septiembre:"#FFCE56",Octubre:"#4BC0C0",Noviembre:"#36A2EB",Diciembre:"#9966FF"},de=(a,m,F)=>{if(!a||!a.startsWith("#"))return"#C9CBCF";try{const d=parseInt(a.slice(1,3),16),j=parseInt(a.slice(3,5),16),l=parseInt(a.slice(5,7),16),p=.2+m/F*.6,y=Math.round(d*p),B=Math.round(j*p),D=Math.round(l*p);return`#${y.toString(16).padStart(2,"0")}${B.toString(16).padStart(2,"0")}${D.toString(16).padStart(2,"0")}`}catch(d){return console.error("Error al generar tono de color:",d),"#C9CBCF"}},me=a=>{const m=a.charAt(0).toUpperCase()+a.slice(1).toLowerCase();return le[m]||"#C9CBCF"},ue=({isOpen:a,onClose:m,gastos:F,titulo:d,total:j})=>{const{formatCurrency:l}=Q();return a?s.jsx("div",{className:"fixed inset-0 z-50 overflow-y-auto",children:s.jsxs("div",{className:"flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0",children:[s.jsx("div",{className:"fixed inset-0 transition-opacity","aria-hidden":"true",children:s.jsx("div",{className:"absolute inset-0 bg-gray-500 opacity-75",onClick:m})}),s.jsxs("div",{className:"inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-2xl sm:w-full",children:[s.jsx("div",{className:"bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4",children:s.jsx("div",{className:"sm:flex sm:items-start",children:s.jsxs("div",{className:"mt-3 text-center sm:mt-0 sm:text-left w-full",children:[s.jsx("h3",{className:"text-lg leading-6 font-medium text-gray-900 mb-4",children:d}),s.jsxs("div",{className:"bg-gray-50 rounded-lg p-4 mb-4",children:[s.jsx("div",{className:"text-2xl font-bold text-indigo-600",children:l(j)}),s.jsx("div",{className:"text-sm text-gray-500",children:"Total de gastos"})]}),s.jsx("div",{className:"space-y-4",children:F.map(p=>s.jsxs("div",{className:"flex items-center justify-between p-3 bg-white border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors",children:[s.jsxs("div",{className:"flex-1 min-w-0",children:[s.jsx("p",{className:"text-sm font-medium text-gray-900 truncate",children:p.descripcion}),s.jsxs("div",{className:"flex items-center mt-1",children:[s.jsx("span",{className:"text-xs text-gray-500",children:new Date(p.fecha).toLocaleDateString("es-ES",{day:"numeric",month:"long",year:"numeric"})}),s.jsx("span",{className:"mx-2 text-gray-300",children:"â€¢"}),s.jsx("span",{className:"text-xs text-gray-500",children:p.escompartido?"Gasto compartido":"Gasto individual"})]})]}),s.jsxs("div",{className:"ml-4 flex-shrink-0",children:[s.jsx("div",{className:"text-sm font-medium text-gray-900",children:l(p.monto)}),p.escompartido&&s.jsxs("div",{className:"text-xs text-gray-500",children:[p.porcentajepersona1,"% /"," ",p.porcentajepersona2,"%"]})]})]},p.id))})]})})}),s.jsx("div",{className:"bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse",children:s.jsx("button",{type:"button",className:"mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm",onClick:m,children:"Cerrar"})})]})]})}):null},we=()=>{const{gastos:a,personas:m}=ie(),{formatCurrency:F}=Q(),d=o.useRef(null),j=o.useRef(null),[l,p]=o.useState("mes"),[y,B]=o.useState("todos"),[D,G]=o.useState(0),[$,M]=o.useState(null),[u,T]=o.useState(null),[xe,pe]=o.useState(null),[he,fe]=o.useState(!1),q=o.useRef(0),[Z,V]=o.useState(!1),[R,_]=o.useState(null),z=o.useCallback(t=>t.reduce((n,e)=>{if(e.escompartido)e.porcentajepersona1&&(n.persona1=(n.persona1||0)+e.monto*e.porcentajepersona1/100),e.porcentajepersona2&&(n.persona2=(n.persona2||0)+e.monto*e.porcentajepersona2/100);else{const i=e.personaid;n[i]=(n[i]||0)+e.monto}return n},{}),[]),X=o.useCallback(()=>{const t=[...a];return u&&u.monto&&u.monto>0&&u.mes&&u.personaid&&t.push(u),y==="todos"?t:t.filter(n=>n.personaid===y||n.escompartido&&(y==="persona1"&&n.porcentajepersona1||y==="persona2"&&n.porcentajepersona2))},[y,a,u]),I=o.useCallback(()=>l==="mes"?ce(X()):z(X()),[l,X,z]),H=o.useCallback(t=>{const n=Object.values(t).reduce((e,i)=>e+i,0);return n===0?{}:Object.entries(t).reduce((e,[i,r])=>(e[i]=r/n*100,e),{})},[]),S=o.useCallback(()=>{const t=I();return H(t)},[H,I]),A=o.useCallback(t=>{const n=m.find(e=>e.id===t);return n?n.nombre:t},[m]),ee=o.useCallback(t=>{switch(t){case"persona1":return"#4F46E5";case"persona2":return"#EC4899";default:return"#9CA3AF"}},[]),Y=t=>{if(l==="mes"){const n=me(t),e=a.filter(r=>r.mes===t),i=e.findIndex(r=>r===a[a.length-1]);return de(n,i,e.length)}else return ee(t)},v=o.useCallback((t=1)=>{if(!d.current)return;const n=d.current,e=n.getContext("2d");if(!e)return;const i=window.devicePixelRatio||1,r=n.getBoundingClientRect();n.width=r.width*i,n.height=r.height*i,e.scale(i,i),n.style.width=`${r.width}px`,n.style.height=`${r.height}px`,e.clearRect(0,0,r.width,r.height);const c=r.width/2,x=r.height/2,g=Math.min(c,x)-20,w=S();if(Object.keys(w).length===0){e.fillStyle="#F3F4F6",e.beginPath(),e.arc(c,x,g,0,Math.PI*2),e.fill(),e.fillStyle="#9CA3AF",e.font="bold 16px Inter, system-ui, sans-serif",e.textAlign="center",e.textBaseline="middle",e.fillText("No hay datos",c,x);return}let h=0;Object.entries(w).forEach(([P,f])=>{const k=f*t,b=h+k/100*(Math.PI*2),C=h+(b-h)/2,E=$===P,N=E?10:0,O=N*Math.cos(C),L=N*Math.sin(C);if(e.fillStyle=Y(P),e.beginPath(),e.moveTo(c+O,x+L),e.arc(c+O,x+L,g,h,b),e.lineTo(c+O,x+L),e.closePath(),e.fill(),e.strokeStyle="#FFFFFF",e.lineWidth=2,e.stroke(),E&&t===1){const W=g*.7,U=c+O+W*Math.cos(C),K=x+L+W*Math.sin(C);e.fillStyle="rgba(255, 255, 255, 0.95)",e.beginPath(),e.roundRect(U-60,K-15,120,30,8),e.fill(),e.fillStyle="#111827",e.font="bold 14px Inter, system-ui, sans-serif",e.textAlign="center",e.textBaseline="middle",e.fillText(`${l==="mes"?P:A(P)}: ${f.toFixed(1)}%`,U,K)}h=b})},[S,$,Y,l,A]),te=o.useCallback(t=>{if(!d.current)return;const e=d.current.getBoundingClientRect(),i=t.clientX-e.left,r=t.clientY-e.top,c=e.width/2,x=e.height/2,g=Math.min(c,x)-20,w=i-c,h=r-x;if(Math.sqrt(w*w+h*h)>g){M(null);return}let f=Math.atan2(h,w);f<0&&(f+=2*Math.PI);const k=S();let b=0;for(const[C,E]of Object.entries(k)){const N=b+E/100*(Math.PI*2);if(f>=b&&f<N){M(C);return}b=N}M(null)},[S]);o.useEffect(()=>{const t=a.length,n=t>q.current;if(q.current=t,!n){v(1);return}G(0);let e;const i=800,r=c=>{e||(e=c);const x=c-e,g=Math.min(x/i,1);G(g),v(g),g<1&&(j.current=requestAnimationFrame(r))};return j.current=requestAnimationFrame(r),()=>{j.current&&cancelAnimationFrame(j.current)}},[a,l,y,v]),o.useEffect(()=>{u&&v(1)},[u,v]),o.useEffect(()=>{v(1);const t=()=>{G(0),T(null),v(1)},n=i=>{G(0),T(null),v(1)},e=i=>{T(i.detail),v(1)};return window.addEventListener("nuevoGasto",t),window.addEventListener("gastoEliminado",n),document.addEventListener("gastoPreview",e),()=>{window.removeEventListener("nuevoGasto",t),window.removeEventListener("gastoEliminado",n),document.removeEventListener("gastoPreview",e)}},[a,l,D,v]);const se=Object.entries(I()).sort(([,t],[,n])=>n-t),ne=Object.values(I()).reduce((t,n)=>t+n,0),re=()=>u&&u.monto&&u.monto>0?s.jsx("span",{className:"absolute top-0 right-0 bg-indigo-100 text-indigo-800 text-xs font-medium px-2.5 py-0.5 rounded-md",children:"Vista previa activa"}):null,oe=t=>({backgroundColor:Y(t)}),J=o.useCallback(t=>{let n=[],e="";l==="mes"?(n=a.filter(r=>r.mes===t),e=`Gastos de ${t}`):(n=a.filter(r=>r.personaid===t||r.escompartido&&(t==="persona1"&&r.porcentajepersona1||t==="persona2"&&r.porcentajepersona2)),e=`Gastos de ${A(t)}`);const i=n.reduce((r,c)=>l==="persona"&&c.escompartido?t==="persona1"?r+c.monto*(c.porcentajepersona1||0)/100:r+c.monto*(c.porcentajepersona2||0)/100:r+c.monto,0);_({gastos:n,titulo:e,total:i}),V(!0)},[l,a,A]),ae=o.useCallback(t=>{if(!d.current)return;const e=d.current.getBoundingClientRect(),i=t.clientX-e.left,r=t.clientY-e.top,c=e.width/2,x=e.height/2,g=Math.min(c,x)-20,w=i-c,h=r-x;if(Math.sqrt(w*w+h*h)>g)return;let f=Math.atan2(h,w);f<0&&(f+=2*Math.PI);const k=S();let b=0;for(const[C,E]of Object.entries(k)){const N=b+E/100*(Math.PI*2);if(f>=b&&f<N){J(C);return}b=N}},[S,J]);return s.jsxs("div",{className:"w-full h-full",children:[s.jsxs("div",{className:"mb-4 sm:mb-6 flex flex-col sm:flex-row gap-4",children:[s.jsxs("div",{className:"flex items-center space-x-2 bg-white p-2 rounded-lg shadow-sm border border-gray-100",children:[s.jsx("span",{className:"text-gray-600 text-sm sm:text-base",children:"Ver por:"}),s.jsxs("select",{value:l,onChange:t=>p(t.target.value),className:"p-1.5 sm:p-2 border rounded-md bg-gray-50 focus:ring-2 focus:ring-indigo-200 focus:border-indigo-500 outline-none text-sm sm:text-base",children:[s.jsx("option",{value:"mes",children:"Mes"}),s.jsx("option",{value:"persona",children:"Persona"})]})]}),s.jsxs("div",{className:"flex items-center space-x-2 bg-white p-2 rounded-lg shadow-sm border border-gray-100",children:[s.jsx("span",{className:"text-gray-600 text-sm sm:text-base",children:"Filtrar:"}),s.jsxs("select",{value:y,onChange:t=>B(t.target.value),className:"p-1.5 sm:p-2 border rounded-md bg-gray-50 focus:ring-2 focus:ring-indigo-200 focus:border-indigo-500 outline-none text-sm sm:text-base",children:[s.jsx("option",{value:"todos",children:"Todos"}),m.map(t=>s.jsx("option",{value:t.id,children:t.nombre},t.id))]})]})]}),s.jsxs("div",{className:"relative bg-white rounded-xl shadow-md p-2 sm:p-4 md:p-6 border border-gray-100",children:[s.jsx(re,{}),s.jsx("div",{className:"relative w-full aspect-square max-w-[300px] mx-auto",children:s.jsx("canvas",{ref:d,className:"absolute inset-0 w-full h-full cursor-pointer",onMouseMove:te,onMouseLeave:()=>M(null),onClick:ae})}),s.jsx("div",{className:"mt-4 sm:mt-6 grid grid-cols-1 sm:grid-cols-2 gap-2 sm:gap-3",children:se.map(([t,n])=>{const e=u&&(l==="mes"&&u.mes===t||l==="persona"&&u.personaid===t);return s.jsxs("div",{className:`flex items-center p-2 sm:p-3 rounded-lg transition-colors ${$===t?"bg-gray-100":e?"bg-indigo-50 border border-indigo-100":"hover:bg-gray-50"}`,onMouseEnter:()=>M(t),onMouseLeave:()=>M(null),children:[s.jsx("span",{className:"w-4 h-4 sm:w-5 sm:h-5 rounded-md inline-block mr-2 sm:mr-3 shadow-sm",style:oe(t)}),s.jsxs("div",{className:"flex-1 min-w-0",children:[s.jsx("span",{className:"font-medium text-gray-800 text-sm sm:text-base truncate",children:l==="mes"?t:A(t)}),s.jsxs("div",{className:"flex justify-between mt-0.5 sm:mt-1",children:[s.jsx("span",{className:"text-xs sm:text-sm text-gray-600 truncate mr-2",children:F(n)}),s.jsxs("span",{className:"text-xs sm:text-sm font-semibold text-indigo-600 whitespace-nowrap",children:[(n/ne*100).toFixed(1),"%"]})]})]})]},t)})})]}),R&&s.jsx(ue,{isOpen:Z,onClose:()=>V(!1),gastos:R.gastos,titulo:R.titulo,total:R.total})]})};export{we as P,ce as c,de as g,me as o};
