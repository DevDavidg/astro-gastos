import{j as n}from"./jsx-runtime.D_zvdyIk.js";import{r as i}from"./index.BVOCwoKb.js";import{u as _}from"./GastosContext.CcSJ84DL.js";import{u as ee}from"./useCurrency.BIWupN6L.js";const te=c=>c.reduce((h,E)=>{const{mes:u,monto:v}=E;return h[u]||(h[u]=0),h[u]+=v,h},{}),se={Enero:"#FF6384",Febrero:"#FF9F40",Marzo:"#FFCE56",Abril:"#4BC0C0",Mayo:"#36A2EB",Junio:"#9966FF",Julio:"#FF6384",Agosto:"#FF9F40",Septiembre:"#FFCE56",Octubre:"#4BC0C0",Noviembre:"#36A2EB",Diciembre:"#9966FF"},ne=(c,h,E)=>{if(!c||!c.startsWith("#"))return"#C9CBCF";try{const u=parseInt(c.slice(1,3),16),v=parseInt(c.slice(3,5),16),l=parseInt(c.slice(5,7),16),P=.2+h/E*.6,x=Math.round(u*P),I=Math.round(v*P),L=Math.round(l*P);return`#${x.toString(16).padStart(2,"0")}${I.toString(16).padStart(2,"0")}${L.toString(16).padStart(2,"0")}`}catch(u){return console.error("Error al generar tono de color:",u),"#C9CBCF"}},oe=c=>{const h=c.charAt(0).toUpperCase()+c.slice(1).toLowerCase();return se[h]||"#C9CBCF"},le=()=>{const{gastos:c,personas:h}=_(),{formatCurrency:E}=ee(),u=i.useRef(null),v=i.useRef(null),[l,P]=i.useState("mes"),[x,I]=i.useState("todos"),[L,N]=i.useState(0),[S,F]=i.useState(null),[o,O]=i.useState(null),q=i.useRef(0),D=i.useCallback(t=>t.reduce((s,e)=>{if(e.escompartido)e.porcentajepersona1&&(s.persona1=(s.persona1||0)+e.monto*e.porcentajepersona1/100),e.porcentajepersona2&&(s.persona2=(s.persona2||0)+e.monto*e.porcentajepersona2/100);else{const r=e.personaid;s[r]=(s[r]||0)+e.monto}return s},{}),[]),T=i.useCallback(()=>{const t=[...c];return o&&o.monto&&o.monto>0&&o.mes&&o.personaid&&t.push(o),x==="todos"?t:t.filter(s=>s.personaid===x||s.escompartido&&(x==="persona1"&&s.porcentajepersona1||x==="persona2"&&s.porcentajepersona2))},[x,c,o]),A=i.useCallback(()=>l==="mes"?te(T()):D(T()),[l,T,D]),V=i.useCallback(t=>{const s=Object.values(t).reduce((e,r)=>e+r,0);return s===0?{}:Object.entries(t).reduce((e,[r,a])=>(e[r]=a/s*100,e),{})},[]),G=i.useCallback(()=>{const t=A();return V(t)},[V,A]),$=i.useCallback(t=>{const s=h.find(e=>e.id===t);return s?s.nombre:t},[h]);i.useCallback(t=>{switch(t){case"persona1":return"#4F46E5";case"persona2":return"#EC4899";default:return"#9CA3AF"}},[]);const X=t=>{if(l==="mes"){const s=oe(t),e=c.filter(a=>a.mes===t),r=e.findIndex(a=>a===c[c.length-1]);return ne(s,r,e.length)}else return"#6B7280"},f=i.useCallback((t=1)=>{if(!u.current)return;const s=u.current,e=s.getContext("2d");if(!e)return;const r=window.devicePixelRatio||1,a=s.getBoundingClientRect();s.width=a.width*r,s.height=a.height*r,e.scale(r,r),s.style.width=`${a.width}px`,s.style.height=`${a.height}px`,e.clearRect(0,0,a.width,a.height);const d=a.width/2,m=a.height/2,p=Math.min(d,m)-20,y=G();if(Object.keys(y).length===0){e.fillStyle="#F3F4F6",e.beginPath(),e.arc(d,m,p,0,Math.PI*2),e.fill(),e.fillStyle="#9CA3AF",e.font="bold 16px Inter, system-ui, sans-serif",e.textAlign="center",e.textBaseline="middle",e.fillText("No hay datos",d,m);return}e.save(),e.shadowColor="rgba(0, 0, 0, 0.1)",e.shadowBlur=10,e.shadowOffsetX=0,e.shadowOffsetY=4,e.beginPath(),e.arc(d,m,p,0,Math.PI*2),e.fill(),e.restore();let b=0;if(S){const g=s.getBoundingClientRect();g.width/2,g.height/2}Object.entries(y).forEach(([g,w])=>{const Y=w*t,j=b+Y/100*(Math.PI*2),M=b+(j-b)/2,R=S===g;let C=R?15:0;o&&o.monto&&o.monto>0&&(l==="mes"&&o.mes===g||l==="persona"&&o.personaid===g)&&(C=Math.max(C,10));const k=C*Math.cos(M),B=C*Math.sin(M);if(e.fillStyle=X(g),e.beginPath(),e.moveTo(d+k,m+B),e.arc(d+k,m+B,p,b,j),e.lineTo(d+k,m+B),e.closePath(),e.fill(),e.strokeStyle="#FFFFFF",e.lineWidth=2,e.stroke(),R&&t===1){const H=p*.7,z=d+k+H*Math.cos(M),J=m+B+H*Math.sin(M);e.fillStyle="rgba(255, 255, 255, 0.9)",e.beginPath(),e.roundRect(z-60,J-15,120,30,8),e.fill(),e.fillStyle="#111827",e.font="bold 14px Inter, system-ui, sans-serif",e.textAlign="center",e.textBaseline="middle",e.fillText(`${l==="mes"?g:$(g)}: ${w.toFixed(1)}%`,z,J)}b=j})},[G,S,X,l,$,o]),W=i.useCallback(t=>{if(!u.current)return;const e=u.current.getBoundingClientRect(),r=t.clientX-e.left,a=t.clientY-e.top,d=e.width/2,m=e.height/2,p=Math.min(d,m)-20,y=r-d,b=a-m;if(Math.sqrt(y*y+b*b)>p){F(null);return}let w=Math.atan2(b,y);w<0&&(w+=2*Math.PI);const Y=G();let j=0;for(const[M,R]of Object.entries(Y)){const C=j+R/100*(Math.PI*2);if(w>=j&&w<C){F(M);return}j=C}F(null)},[G]);i.useEffect(()=>{const t=c.length,s=t>q.current;if(q.current=t,!s){f(1);return}N(0);let e;const r=800,a=d=>{e||(e=d);const m=d-e,p=Math.min(m/r,1);N(p),f(p),p<1&&(v.current=requestAnimationFrame(a))};return v.current=requestAnimationFrame(a),()=>{v.current&&cancelAnimationFrame(v.current)}},[c,l,x,f]),i.useEffect(()=>{o&&f(1)},[o,f]),i.useEffect(()=>{f(1);const t=()=>{N(0),O(null),f(1)},s=r=>{console.log("Gasto eliminado:",r.detail),N(0),O(null),f(1)},e=r=>{O(r.detail),f(1)};return window.addEventListener("nuevoGasto",t),window.addEventListener("gastoEliminado",s),document.addEventListener("gastoPreview",e),()=>{window.removeEventListener("nuevoGasto",t),window.removeEventListener("gastoEliminado",s),document.removeEventListener("gastoPreview",e)}},[c,l,L,f]);const U=Object.entries(A()).sort(([,t],[,s])=>s-t),K=Object.values(A()).reduce((t,s)=>t+s,0),Q=()=>o&&o.monto&&o.monto>0?n.jsx("span",{className:"absolute top-0 right-0 bg-indigo-100 text-indigo-800 text-xs font-medium px-2.5 py-0.5 rounded-md",children:"Vista previa activa"}):null,Z=t=>({backgroundColor:X(t)});return n.jsxs("div",{className:"w-full h-full",children:[n.jsxs("div",{className:"mb-4 sm:mb-6 flex flex-col sm:flex-row gap-4",children:[n.jsxs("div",{className:"flex items-center space-x-2 bg-white p-2 rounded-lg shadow-sm border border-gray-100 transition-all hover:shadow-md",children:[n.jsx("span",{className:"text-gray-600 text-sm sm:text-base",children:"Ver por:"}),n.jsxs("select",{value:l,onChange:t=>P(t.target.value),className:"p-1.5 sm:p-2 border rounded-md bg-gray-50 focus:ring-2 focus:ring-indigo-200 focus:border-indigo-500 outline-none transition-all text-sm sm:text-base",children:[n.jsx("option",{value:"mes",children:"Mes"}),n.jsx("option",{value:"persona",children:"Persona"})]})]}),n.jsxs("div",{className:"flex items-center space-x-2 bg-white p-2 rounded-lg shadow-sm border border-gray-100 transition-all hover:shadow-md",children:[n.jsx("span",{className:"text-gray-600 text-sm sm:text-base",children:"Filtrar:"}),n.jsxs("select",{value:x,onChange:t=>I(t.target.value),className:"p-1.5 sm:p-2 border rounded-md bg-gray-50 focus:ring-2 focus:ring-indigo-200 focus:border-indigo-500 outline-none transition-all text-sm sm:text-base",children:[n.jsx("option",{value:"todos",children:"Todos"}),h.map(t=>n.jsx("option",{value:t.id,children:t.nombre},t.id))]})]})]}),n.jsxs("div",{className:"relative bg-white rounded-xl shadow-md p-2 sm:p-4 md:p-6 border border-gray-100 transition-all hover:shadow-lg",children:[n.jsx(Q,{}),n.jsx("div",{className:"relative w-full aspect-square max-w-[300px] mx-auto",children:n.jsx("canvas",{ref:u,className:"absolute inset-0 w-full h-full cursor-pointer",onMouseMove:W,onMouseLeave:()=>F(null)})}),n.jsx("div",{className:"mt-4 sm:mt-6 grid grid-cols-1 sm:grid-cols-2 gap-2 sm:gap-3",children:U.map(([t,s])=>{const e=o&&(l==="mes"&&o.mes===t||l==="persona"&&o.personaid===t);return n.jsxs("div",{className:`flex items-center p-2 sm:p-3 rounded-lg transition-all ${S===t?"bg-gray-100 scale-105":e?"bg-indigo-50 border border-indigo-100":"hover:bg-gray-50"}`,onMouseEnter:()=>F(t),onMouseLeave:()=>F(null),children:[n.jsx("span",{className:"w-4 h-4 sm:w-5 sm:h-5 rounded-md inline-block mr-2 sm:mr-3 shadow-sm",style:Z(t)}),n.jsxs("div",{className:"flex-1 min-w-0",children:[n.jsx("span",{className:"font-medium text-gray-800 text-sm sm:text-base truncate",children:l==="mes"?t:$(t)}),n.jsxs("div",{className:"flex justify-between mt-0.5 sm:mt-1",children:[n.jsx("span",{className:"text-xs sm:text-sm text-gray-600 truncate mr-2",children:E(s)}),n.jsxs("span",{className:"text-xs sm:text-sm font-semibold text-indigo-600 whitespace-nowrap",children:[(s/K*100).toFixed(1),"%"]})]})]})]},t)})})]})]})};export{le as P,te as c,ne as g,oe as o};
