import{j as b}from"./jsx-runtime.D_zvdyIk.js";import{r as l}from"./index.BVOCwoKb.js";import{s as i}from"./supabase.4P1wv7wr.js";import A from"./LoadingSpinner.D7PxHcXC.js";const T=async()=>{const{data:t,error:s}=await i.from("personas").select("*");if(s)throw console.error("Error al obtener personas:",s),s;return t||[]},J=async()=>{const{data:{user:t},error:s}=await i.auth.getUser();if(s||!t)throw console.error("Error al obtener usuario:",s),new Error("Usuario no autenticado");const{data:n,error:u}=await i.from("gastos").select("*").eq("usuarioid",t.id);if(u)throw console.error("Error al obtener gastos del usuario:",u),u;const{data:d,error:m}=await i.from("gastos").select("*").eq("otrapersonaemail",t.email);if(m)throw console.error("Error al obtener gastos compartidos:",m),m;return[...n||[],...d||[]].filter((c,E,g)=>E===g.findIndex(h=>h.id===c.id)).map(c=>({...c,otraPersonaEmail:c.otrapersonaemail,fecha:new Date(c.fecha),fechaCreacion:c.fechaCreacion?new Date(c.fechaCreacion):void 0,fechaActualizacion:c.fechaActualizacion?new Date(c.fechaActualizacion):void 0}))},M=async t=>{try{const{data:{user:s}}=await i.auth.getUser();if(!s)throw new Error("Usuario no autenticado");const{data:n,error:u}=await i.from("gastos").select("*").eq("id",t).single();if(u||!n){console.error("No se encontró el gasto:",u);return}const d=n.usuarioid===s.id,m=n.otrapersonaemail===s.email;if(!d&&!m)throw console.error("El usuario no tiene permisos para eliminar este gasto"),new Error("No tienes permisos para eliminar este gasto");const{error:w}=await i.from("gastos").delete().eq("id",t);if(w)throw console.error("Error al eliminar gasto:",w),w;await new Promise(c=>setTimeout(c,1e3));const{data:f}=await i.from("gastos").select("id").eq("id",t);if(f&&f.length>0)throw console.error("El gasto sigue existiendo después de la eliminación"),new Error("El gasto no se eliminó correctamente")}catch(s){throw console.error("Error en eliminarGasto:",s),s}},O=async(t,s)=>{const{error:n}=await i.from("personas").update({sueldo:s}).eq("id",t);if(n)throw console.error("Error al actualizar sueldo:",n),n},R=async(t,s)=>{const{error:n}=await i.from("personas").update({nombre:s}).eq("id",t);if(n)throw console.error("Error al actualizar nombre:",n),n},H=async t=>{const{data:s,error:n}=await i.rpc("get_user_email_by_persona_id",{persona_id:t});return n?(console.error("Error al obtener email de usuario:",n),null):s??null},S="user_preferences",P={currency:"USD",theme:"light",language:"es"},q=()=>{if(typeof window>"u")return P;const t=localStorage.getItem(S);if(!t)return localStorage.setItem(S,JSON.stringify(P)),P;try{return JSON.parse(t)}catch{return P}},F=t=>{const n={...q(),...t};return localStorage.setItem(S,JSON.stringify(n)),n},$=l.createContext(void 0),Q=({children:t})=>{const[s,n]=l.useState([]),[u,d]=l.useState([]),[m,w]=l.useState(!0),[f,c]=l.useState(null),[E,g]=l.useState(null),[h,z]=l.useState(!1);l.useEffect(()=>{let o=!0;(async()=>{try{const{data:a}=await i.auth.getSession();o&&(c(a.session?.user||null),z(!0))}catch(a){console.error("Error initializing auth:",a),o&&z(!0)}})();const{data:{subscription:e}}=i.auth.onAuthStateChange((a,p)=>{o&&c(p?.user||null)});return()=>{o=!1,e.unsubscribe()}},[]),l.useEffect(()=>{h&&f&&G()},[f,h]);const G=async()=>{if(f){w(!0);try{const[o,r,e]=await Promise.all([J(),T(),q()]);r&&r.length>0?(n(o),d(r),g(e)):(console.error("No personas found in database"),n([]),d([]))}catch(o){console.error("Error al cargar datos:",o),n([]),d([])}finally{w(!1)}}},y=async()=>{await G()},U=async(o,r,e)=>{const{error:a}=await i.from("notifications").insert({user_id:o,title:`Nuevo gasto compartido de ${r.nombre}`,message:`${e.descripcion} - Monto: ${e.monto} - Tu porcentaje: ${e.porcentajepersona2}%`});a&&console.error("Error al crear notificación:",a)},I=async(o,r,e)=>{try{const{data:a}=await i.from("personas").select("usuarioid, email").eq("email",o).maybeSingle();if(a){await U(a.usuarioid,r,e);return}const{data:p}=await i.rpc("get_user_id_by_email",{email_input:o});p?.[0]?.id&&await U(p[0].id,r,e)}catch(a){console.error("Error al procesar notificación:",a)}},j=async o=>{if(!f)throw new Error("Usuario no autenticado");try{const{otraPersonaEmail:r,...e}=o;if(await y(),e.escompartido&&r){const a=u.find(p=>p.id===e.personaid);if(!a){console.error("No se encontró la persona principal");return}await I(r,a,e)}}catch(r){throw console.error("Error al agregar gasto:",r),r}},N=async o=>{try{n(r=>{const e=r.filter(a=>a.id!==o);return window.dispatchEvent(new CustomEvent("gastoEliminado",{detail:{id:o}})),e}),M(o).catch(r=>{console.error("Error al eliminar el gasto:",r),y()})}catch(r){throw console.error("Error al eliminar el gasto:",r),r}},x=async(o,r)=>{try{await O(o,r),d(e=>e.map(a=>a.id===o?{...a,sueldo:r}:a))}catch(e){throw console.error("Error al actualizar sueldo:",e),e}},v=async(o,r)=>{try{await R(o,r),d(e=>e.map(a=>a.id===o?{...a,nombre:r}:a))}catch(e){throw console.error("Error al actualizar nombre:",e),e}},_=async o=>{try{if(!f){console.error("No user found when updating preferences");return}const r=F(o);r?g(r):console.error("Failed to update user preferences")}catch(r){console.error("Error al actualizar preferencias:",r)}},C=o=>s.reduce((r,e)=>e.personaid===o?r+e.monto:e.escompartido&&e.porcentajepersona1&&e.porcentajepersona2?r+e.monto*(o==="persona1"?e.porcentajepersona1:e.porcentajepersona2)/100:r,0),D=(o,r)=>{const e=o+r;if(e===0)return{porcentajePersona1:50,porcentajePersona2:50};const a=Math.round(o/e*100),p=100-a;return{porcentajePersona1:a,porcentajePersona2:p}},L=l.useMemo(()=>({gastos:s,personas:u,isLoading:m,userPreferences:E,agregarGasto:j,eliminarGasto:N,actualizarSueldoPersona:x,actualizarNombrePersona:v,obtenerTotalGastosPorPersona:C,calcularPorcentajeGasto:D,recargarDatos:y,updateUserPreferences:_}),[s,u,m,E,j,N,x,v,C,D,y,_]);return h?b.jsx($.Provider,{value:L,children:t}):b.jsx("div",{className:"flex justify-center items-center h-64",children:b.jsx(A,{size:"large",color:"primary"})})};function V(){const t=l.useContext($);if(t===void 0)throw new Error("useGastos debe ser usado dentro de un GastosProvider");return t}export{Q as G,H as o,V as u};
