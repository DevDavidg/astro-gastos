import{j as G}from"./jsx-runtime.D_zvdyIk.js";import{r as d}from"./index.BVOCwoKb.js";import{s as i}from"./supabase.4P1wv7wr.js";import x from"./LoadingSpinner.D7PxHcXC.js";const C=async()=>{const{data:e,error:s}=await i.from("personas").select("*");if(s)throw console.error("Error al obtener personas:",s),s;return e||[]},$=async()=>{const{data:{user:e},error:s}=await i.auth.getUser();if(s||!e)throw console.error("Error al obtener usuario:",s),new Error("Usuario no autenticado");const{data:a,error:l}=await i.from("gastos").select("*").eq("usuarioid",e.id);if(l)throw console.error("Error al obtener gastos del usuario:",l),l;const{data:f,error:p}=await i.from("gastos").select("*").eq("otrapersonaemail",e.email);if(p)throw console.error("Error al obtener gastos compartidos:",p),p;return[...a||[],...f||[]].filter((c,j,P)=>j===P.findIndex(g=>g.id===c.id)).map(c=>({...c,otraPersonaEmail:c.otrapersonaemail,fecha:new Date(c.fecha),fechaCreacion:c.fechaCreacion?new Date(c.fechaCreacion):void 0,fechaActualizacion:c.fechaActualizacion?new Date(c.fechaActualizacion):void 0}))},q=async e=>{if(!e.usuarioid)throw new Error("El usuario_id es requerido para crear un gasto");const s={mes:e.mes,descripcion:e.descripcion,monto:e.monto,fecha:e.fecha.toISOString().split("T")[0],personaid:e.personaid,escompartido:e.escompartido,porcentajepersona1:e.porcentajepersona1,porcentajepersona2:e.porcentajepersona2,usuarioid:e.usuarioid,otrapersonaemail:e.otraPersonaEmail||null},{data:a,error:l}=await i.from("gastos").insert(s).select().single();if(l)throw console.error("Error al crear gasto:",l),l;return{...a,otraPersonaEmail:a.otrapersonaemail,fecha:new Date(a.fecha),fechaCreacion:a.fechaCreacion?new Date(a.fechaCreacion):void 0,fechaActualizacion:a.fechaActualizacion?new Date(a.fechaActualizacion):void 0}},I=async e=>{try{const{data:{user:s}}=await i.auth.getUser();if(!s)throw new Error("Usuario no autenticado");const{data:a,error:l}=await i.from("gastos").select("*").eq("id",e).single();if(l||!a){console.error("No se encontró el gasto:",l);return}const f=a.usuarioid===s.id,p=a.otrapersonaemail===s.email;if(!f&&!p)throw console.error("El usuario no tiene permisos para eliminar este gasto"),new Error("No tienes permisos para eliminar este gasto");const{error:m}=await i.from("gastos").delete().eq("id",e);if(m)throw console.error("Error al eliminar gasto:",m),m;await new Promise(c=>setTimeout(c,1e3));const{data:u}=await i.from("gastos").select("id").eq("id",e);if(u&&u.length>0)throw console.error("El gasto sigue existiendo después de la eliminación"),new Error("El gasto no se eliminó correctamente")}catch(s){throw console.error("Error en eliminarGasto:",s),s}},A=async(e,s)=>{const{error:a}=await i.from("personas").update({sueldo:s}).eq("id",e);if(a)throw console.error("Error al actualizar sueldo:",a),a},T=async(e,s)=>{const{error:a}=await i.from("personas").update({nombre:s}).eq("id",e);if(a)throw console.error("Error al actualizar nombre:",a),a},X=async e=>{const{data:s,error:a}=await i.rpc("get_user_email_by_persona_id",{persona_id:e});return a?(console.error("Error al obtener email de usuario:",a),null):s||null},z="user_preferences",y={currency:"USD",theme:"light",language:"es"},v=()=>{if(typeof window>"u")return y;const e=localStorage.getItem(z);if(!e)return localStorage.setItem(z,JSON.stringify(y)),y;try{return JSON.parse(e)}catch{return y}},L=e=>{const a={...v(),...e};return localStorage.setItem(z,JSON.stringify(a)),a},N=d.createContext(void 0);function Z({children:e}){const[s,a]=d.useState([]),[l,f]=d.useState([]),[p,m]=d.useState(!0),[u,c]=d.useState(null),[j,P]=d.useState(null),[g,S]=d.useState(!1);d.useEffect(()=>{let t=!0;(async()=>{try{const{data:n}=await i.auth.getSession();t&&(c(n.session?.user||null),S(!0))}catch(n){console.error("Error initializing auth:",n),t&&S(!0)}})();const{data:{subscription:r}}=i.auth.onAuthStateChange((n,h)=>{t&&c(h?.user||null)});return()=>{t=!1,r.unsubscribe()}},[]),d.useEffect(()=>{g&&u&&U()},[u,g]);const U=async()=>{if(u){m(!0);try{const[t,o,r]=await Promise.all([$(),C(),v()]);o&&o.length>0?(a(t),f(o),P(r)):(console.error("No personas found in database"),a([]),f([]))}catch(t){console.error("Error al cargar datos:",t),a([]),f([])}finally{m(!1)}}},b=async()=>{await U()},_={gastos:s,personas:l,isLoading:p,userPreferences:j,agregarGasto:async t=>{if(!u)throw new Error("Usuario no autenticado");try{const{otraPersonaEmail:o,...r}=t,n=await q({...r,personaid:r.personaid,escompartido:r.escompartido,porcentajepersona1:r.porcentajepersona1,porcentajepersona2:r.porcentajepersona2,fecha:new Date,usuarioid:u.id,otraPersonaEmail:o});if(await b(),r.escompartido&&o){const h=l.find(w=>w.id===r.personaid);if(!h){console.error("No se encontró la persona principal");return}try{const{data:w,error:K}=await i.from("personas").select("usuarioid, email").eq("email",o).maybeSingle();if(w){const{error:E}=await i.from("notifications").insert({user_id:w.usuarioid,title:`Nuevo gasto compartido de ${h.nombre}`,message:`${r.descripcion} - Monto: ${r.monto} - Tu porcentaje: ${r.porcentajepersona2}%`});E&&console.error("Error al crear notificación:",E)}else{const{data:E,error:Y}=await i.rpc("get_user_id_by_email",{email_input:o});if(E&&E.length>0){const{error:D}=await i.from("notifications").insert({user_id:E[0].id,title:`Nuevo gasto compartido de ${h.nombre}`,message:`${r.descripcion} - Monto: ${r.monto} - Tu porcentaje: ${r.porcentajepersona2}%`});D&&console.error("Error al crear notificación:",D)}}}catch(w){console.error("Error al procesar notificación:",w)}}}catch(o){throw console.error("Error al agregar gasto:",o),o}},eliminarGasto:async t=>{try{a(o=>{const r=o.filter(n=>n.id!==t);return window.dispatchEvent(new CustomEvent("gastoEliminado",{detail:{id:t}})),r}),I(t).catch(o=>{console.error("Error al eliminar el gasto:",o),b()})}catch(o){throw console.error("Error al eliminar el gasto:",o),o}},actualizarSueldoPersona:async(t,o)=>{try{await A(t,o),f(r=>r.map(n=>n.id===t?{...n,sueldo:o}:n))}catch(r){throw console.error("Error al actualizar sueldo:",r),r}},actualizarNombrePersona:async(t,o)=>{try{await T(t,o),f(r=>r.map(n=>n.id===t?{...n,nombre:o}:n))}catch(r){throw console.error("Error al actualizar nombre:",r),r}},obtenerTotalGastosPorPersona:t=>s.reduce((o,r)=>r.personaid===t?o+r.monto:r.escompartido&&r.porcentajepersona1&&r.porcentajepersona2?o+r.monto*(t==="persona1"?r.porcentajepersona1:r.porcentajepersona2)/100:o,0),calcularPorcentajeGasto:(t,o)=>{const r=t+o;if(r===0)return{porcentajePersona1:50,porcentajePersona2:50};const n=Math.round(t/r*100),h=100-n;return{porcentajePersona1:n,porcentajePersona2:h}},recargarDatos:b,updateUserPreferences:async t=>{try{if(!u){console.error("No user found when updating preferences");return}const o=await L(t);o?P(o):console.error("Failed to update user preferences")}catch(o){console.error("Error al actualizar preferencias:",o)}}};return g?G.jsx(N.Provider,{value:_,children:e}):G.jsx("div",{className:"flex justify-center items-center h-64",children:G.jsx(x,{size:"large",color:"primary"})})}function rr(){const e=d.useContext(N);if(e===void 0)throw new Error("useGastos debe ser usado dentro de un GastosProvider");return e}export{Z as G,X as o,rr as u};
