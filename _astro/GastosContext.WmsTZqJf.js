import{j as z}from"./jsx-runtime.D_zvdyIk.js";import{r as l}from"./index.BVOCwoKb.js";import{s as i}from"./supabase.4P1wv7wr.js";import O from"./LoadingSpinner.D7PxHcXC.js";const R=async()=>{const{data:t,error:s}=await i.from("personas").select("*");if(s)throw console.error("Error al obtener personas:",s),s;return t||[]},F=async()=>{const{data:{user:t},error:s}=await i.auth.getUser();if(s||!t)throw console.error("Error al obtener usuario:",s),new Error("Usuario no autenticado");const{data:n,error:u}=await i.from("gastos").select("*").eq("usuarioid",t.id);if(u)throw console.error("Error al obtener gastos del usuario:",u),u;const{data:f,error:m}=await i.from("gastos").select("*").eq("otrapersonaemail",t.email);if(m)throw console.error("Error al obtener gastos compartidos:",m),m;return[...n||[],...f||[]].filter((c,E,g)=>E===g.findIndex(w=>w.id===c.id)).map(c=>({...c,otraPersonaEmail:c.otrapersonaemail,fecha:new Date(c.fecha),fechaCreacion:c.fechaCreacion?new Date(c.fechaCreacion):void 0,fechaActualizacion:c.fechaActualizacion?new Date(c.fechaActualizacion):void 0}))},k=async t=>{try{const{data:{user:s}}=await i.auth.getUser();if(!s)throw new Error("Usuario no autenticado");const{data:n,error:u}=await i.from("gastos").select("*").eq("id",t).single();if(u||!n){console.error("No se encontró el gasto:",u);return}const f=n.usuarioid===s.id,m=n.otrapersonaemail===s.email;if(!f&&!m)throw console.error("El usuario no tiene permisos para eliminar este gasto"),new Error("No tienes permisos para eliminar este gasto");const{error:p}=await i.from("gastos").delete().eq("id",t);if(p)throw console.error("Error al eliminar gasto:",p),p;await new Promise(c=>setTimeout(c,1e3));const{data:h}=await i.from("gastos").select("id").eq("id",t);if(h&&h.length>0)throw console.error("El gasto sigue existiendo después de la eliminación"),new Error("El gasto no se eliminó correctamente")}catch(s){throw console.error("Error en eliminarGasto:",s),s}},B=async(t,s)=>{const{error:n}=await i.from("personas").update({sueldo:s}).eq("id",t);if(n)throw console.error("Error al actualizar sueldo:",n),n},K=async(t,s)=>{const{error:n}=await i.from("personas").update({nombre:s}).eq("id",t);if(n)throw console.error("Error al actualizar nombre:",n),n},Y=async t=>{const{data:s,error:n}=await i.rpc("get_user_email_by_persona_id",{persona_id:t});return n?(console.error("Error al obtener email de usuario:",n),null):s??null},G="user_preferences",b={currency:"USD",theme:"light",language:"es"},U=()=>{if(typeof window>"u")return b;const t=localStorage.getItem(G);if(!t)return localStorage.setItem(G,JSON.stringify(b)),b;try{return JSON.parse(t)}catch{return b}},H=t=>{const n={...U(),...t};return localStorage.setItem(G,JSON.stringify(n)),n},T=l.createContext(void 0),Z=({children:t})=>{const[s,n]=l.useState([]),[u,f]=l.useState([]),[m,p]=l.useState(!0),[h,c]=l.useState({}),[E,g]=l.useState(U()),[w,j]=l.useState(null),[S,x]=l.useState(!1);l.useEffect(()=>{let o=!0;(async()=>{try{const{data:a}=await i.auth.getSession();o&&(j(a.session?.user||null),x(!0))}catch(a){console.error("Error initializing auth:",a),o&&x(!0)}})();const{data:{subscription:e}}=i.auth.onAuthStateChange((a,d)=>{o&&j(d?.user||null)});return()=>{o=!1,e.unsubscribe()}},[]),l.useEffect(()=>{S&&w&&N()},[w,S]);const N=async()=>{if(w){p(!0);try{const[o,r,e]=await Promise.all([F(),R(),U()]);if(r&&r.length>0){const a={},d=[...new Set(o.map(P=>P.personaid))];await Promise.all(d.map(async P=>{const M=await Y(P);M&&(a[P]=M)})),c(a),n(o),f(r),g(e)}else console.error("No personas found in database"),n([]),f([])}catch(o){console.error("Error al cargar datos:",o),n([]),f([])}finally{p(!1)}}},y=async()=>{await N()},_=async(o,r,e)=>{const{error:a}=await i.from("notifications").insert({user_id:o,title:`Nuevo gasto compartido de ${r.nombre}`,message:`${e.descripcion} - Monto: ${e.monto} - Tu porcentaje: ${e.porcentajepersona2}%`});a&&console.error("Error al crear notificación:",a)},A=async(o,r,e)=>{try{const{data:a}=await i.from("personas").select("usuarioid, email").eq("email",o).maybeSingle();if(a){await _(a.usuarioid,r,e);return}const{data:d}=await i.rpc("get_user_id_by_email",{email_input:o});d?.[0]?.id&&await _(d[0].id,r,e)}catch(a){console.error("Error al procesar notificación:",a)}},v=async o=>{if(!w)throw new Error("Usuario no autenticado");try{const{otraPersonaEmail:r,...e}=o;if(await y(),e.escompartido&&r){const a=u.find(d=>d.id===e.personaid);if(!a){console.error("No se encontró la persona principal");return}await A(r,a,e)}}catch(r){throw console.error("Error al agregar gasto:",r),r}},C=async o=>{try{n(r=>{const e=r.filter(a=>a.id!==o);return window.dispatchEvent(new CustomEvent("gastoEliminado",{detail:{id:o}})),e}),k(o).catch(r=>{console.error("Error al eliminar el gasto:",r),y()})}catch(r){throw console.error("Error al eliminar el gasto:",r),r}},D=async(o,r)=>{try{await B(o,r),f(e=>e.map(a=>a.id===o?{...a,sueldo:r}:a))}catch(e){throw console.error("Error al actualizar sueldo:",e),e}},q=async(o,r)=>{try{await K(o,r),f(e=>e.map(a=>a.id===o?{...a,nombre:r}:a))}catch(e){throw console.error("Error actualizando nombre de persona:",e),e}},$=async o=>{try{if(!w){console.error("No user found when updating preferences");return}const r=H(o);r?g(r):console.error("Failed to update user preferences")}catch(r){console.error("Error al actualizar preferencias:",r)}},I=o=>s.reduce((r,e)=>e.personaid===o?r+e.monto:e.escompartido&&e.porcentajepersona1&&e.porcentajepersona2?r+e.monto*(o==="persona1"?e.porcentajepersona1:e.porcentajepersona2)/100:r,0),L=(o,r)=>{const e=o+r;if(e===0)return{porcentajePersona1:50,porcentajePersona2:50};const a=Math.round(o/e*100),d=100-a;return{porcentajePersona1:a,porcentajePersona2:d}},J=l.useMemo(()=>({gastos:s,personas:u,isLoading:m,userPreferences:E,emailsMap:h,agregarGasto:v,eliminarGasto:C,actualizarSueldoPersona:D,actualizarNombrePersona:q,obtenerTotalGastosPorPersona:I,calcularPorcentajeGasto:L,recargarDatos:y,setUserPreferences:$}),[s,u,m,E,h,v,C,D,q,I,L,y,$]);return S?z.jsx(T.Provider,{value:J,children:t}):z.jsx("div",{className:"flex justify-center items-center h-64",children:z.jsx(O,{size:"large",color:"primary"})})};function rr(){const t=l.useContext(T);if(t===void 0)throw new Error("useGastos debe ser usado dentro de un GastosProvider");return t}export{Z as G,rr as u};
